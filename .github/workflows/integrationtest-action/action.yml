name: "Execute IntegrationTests"
description: "Executes all integration tests"
inputs:
  extended:
    description: 'Execute extended integration tests (with docker) or not'
    required: true
  nexus_user:
    description: 'Nexus Username'
    required: true
  nexus_password:
    description: 'Nexus Password'
    required: true
  k8s_user:
    description: 'Username for K8s Registry Login'
    required: false
  k8s_password:
    description: 'Password for K8s Registry Login'
    required: false

runs:
  using: "composite"
  steps:
    # Build vorbereiten
    - name: Prepare Maven Build
      uses: ./.github/workflows/prepare-action
      with:
        nexus_user: ${{ inputs.nexus_user }}
        nexus_password: ${{ inputs.nexus_password }}

    # EXTENDED: Docker Login auf ADITO registry
    - name: Login to ADITO K8s Registry
      if: inputs.extended == 'true'
      uses: docker/login-action@v2
      with:
        registry: registry.k8s.adito.de
        username: ${{ inputs.k8s_user }}
        password: ${{ inputs.k8s_password }}

    # EXTENDED: Image Cache f�r Docker bereitstellen
    - name: Docker Image Cache
      if: inputs.extended == 'true'
      id: image-cache
      uses: actions/cache@v1
      with:
        path: ~/image-cache
        key: image-cache-${{ runner.os }}

    # EXTENDED: Caches laden, wenn vorhanden
    - name: Load Docker Images from Cache
      if: steps.image-cache.outputs.cache-hit == 'true' && inputs.extended == 'true'
      shell: bash
      run: docker load -i ~/image-cache/images.tar

    # EXTENDED: Extended IntegrationTests ausf�hren
    - name: Integration Tests
      if: inputs.extended == 'true'
      working-directory: ./modules
      shell: bash
      run: mvn --batch-mode -T 1C -Padito.maven.integrationtests.extended failsafe:integration-test failsafe:verify

    # Normale IntegrationTests ausf�hren
    - name: Integration Tests
      if: inputs.extended == 'false'
      working-directory: ./modules
      shell: bash
      run: mvn --batch-mode -T 1C -Padito.maven.integrationtests failsafe:integration-test failsafe:verify

    # EXTENDED: Docker Images persistieren
    - name: Persist Docker Images
      if: inputs.extended == 'true'
      shell: bash
      run: mkdir -p ~/image-cache && docker save -o ~/image-cache/images.tar $(docker images -q)